<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Hacker Simulator | å¢é•¿é»‘å®¢æ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="ui-effects.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .game-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-header .subtitle {
            opacity: 0.9;
            font-size: 1.2em;
        }

        .level-indicator {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            text-transform: uppercase;
        }

        .metric-change {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #28a745;
        }

        .metric-change.negative {
            color: #dc3545;
        }

        .content {
            padding: 40px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .mode-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .mode-card .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .mode-card h3 {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .mode-card p {
            color: #6c757d;
            line-height: 1.6;
        }

        .scenario-display {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .scenario-display h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .company-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .challenge-box {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin-top: 20px;
        }

        .challenge-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .skills-available {
            margin: 30px 0;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .skill-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .skill-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .skill-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .skill-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .skill-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }

        .skill-desc {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.5;
        }

        .skill-cost {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .skill-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-top: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: inline-block;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .result-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 3px solid #28a745;
        }

        .result-panel h3 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .result-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            text-align: center;
            transition: transform 0.3s;
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .achievement-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .final-plan {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
        }

        .final-plan h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .plan-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .plan-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .timeline {
            margin: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }

        .timeline-item::before {
            content: 'â—';
            position: absolute;
            left: 0;
            color: #667eea;
            font-size: 1.5em;
        }

        .week-label {
            font-weight: bold;
            min-width: 100px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
            }

            .metrics-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="achievement-popup" id="achievement-popup">
        <div class="achievement-icon">ğŸ†</div>
        <h2 id="achievement-title"></h2>
        <p id="achievement-desc"></p>
        <button class="btn" onclick="closeAchievement()">ç»§ç»­ Continue</button>
    </div>

    <div class="container">
        <div class="game-header">
            <div class="level-indicator" id="level-indicator">å…³å¡ 1/6</div>
            <h1>ğŸš€ å¢é•¿é»‘å®¢æ¨¡æ‹Ÿå™¨</h1>
            <div class="subtitle">Growth Hacker Simulator</div>
        </div>

        <div class="metrics-dashboard" id="metrics-dashboard">
            <!-- Metrics will be dynamically inserted -->
        </div>

        <!-- Office Scene Visualization -->
        <div id="office-scene-container" style="padding: 0 30px; display: none;">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="content">
            <!-- Welcome Screen -->
            <div class="screen active" id="welcome-screen">
                <h2 style="text-align: center; margin-bottom: 30px; font-size: 2em;">
                    é€‰æ‹©ä½ çš„æ¸¸æˆæ¨¡å¼ Choose Your Game Mode
                </h2>
                <div class="mode-selection">
                    <div class="mode-card" onclick="startGame('real')">
                        <div class="icon">ğŸ’¼</div>
                        <h3>çœŸå®ä¸šåŠ¡æ¨¡å¼</h3>
                        <h4 style="color: #6c757d; margin-bottom: 10px;">Real Business Mode</h4>
                        <p>è¾“å…¥ä½ çš„çœŸå®ä¸šåŠ¡ä¿¡æ¯ï¼Œåœ¨æ¸¸æˆä¸­æ¨¡æ‹Ÿä½ çš„å®é™…å¢é•¿æŒ‘æˆ˜ã€‚é€‚åˆåˆ›ä¸šè€…å’Œè¿è¥äººå‘˜å®æˆ˜æ¼”ç»ƒã€‚</p>
                        <p style="margin-top: 10px;">Input your real business and simulate your actual growth challenges. Perfect for entrepreneurs and operators.</p>
                    </div>
                    <div class="mode-card" onclick="startGame('ai')">
                        <div class="icon">ğŸ®</div>
                        <h3>AIç”ŸæˆæŒ‘æˆ˜</h3>
                        <h4 style="color: #6c757d; margin-bottom: 10px;">AI Challenge Mode</h4>
                        <p>AIéšæœºç”Ÿæˆé«˜éš¾åº¦åœºæ™¯ï¼Œæµ‹è¯•ä½ çš„å¢é•¿é»‘å®¢æŠ€èƒ½ã€‚é€‚åˆå­¦ä¹ å’Œç»ƒä¹ å„ç§å¢é•¿ç­–ç•¥ã€‚</p>
                        <p style="margin-top: 10px;">AI generates challenging scenarios to test your growth hacking skills. Perfect for learning various growth strategies.</p>
                    </div>
                </div>
            </div>

            <!-- Game Screens will be dynamically loaded -->
            <div class="screen" id="game-screen"></div>
            <div class="screen" id="result-screen"></div>
            <div class="screen" id="final-screen"></div>
        </div>
    </div>

    <!-- Core Systems -->
    <script src="growth-game-engine.js"></script>
    <script src="game-engine-v2.js"></script>

    <!-- Advanced Systems -->
    <script src="combo-system.js"></script>
    <script src="meta-progression.js"></script>
    <script src="scenarios-library.js"></script>
    <script src="achievements-data.js"></script>
    <script src="decision-ui-addon.js"></script>

    <!-- Animations -->
    <script src="animations.js"></script>
    <script>
        let gameEngine;
        let previousMetrics = {};
        let decisionUI;
        let comboSystem;
        let metaProgression;
        let advancedSystemsEnabled = true; // Toggle advanced features

        // Initialize all systems on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize decision UI
            if (typeof DecisionUI !== 'undefined') {
                decisionUI = new DecisionUI('game-screen');
            }

            // Initialize meta-progression system
            if (typeof MetaProgressionSystem !== 'undefined') {
                metaProgression = new MetaProgressionSystem();
                console.log('Meta-progression loaded. Level:', metaProgression.playerProfile.level);
            }

            // Add ripple effects to all interactive elements
            document.addEventListener('click', (e) => {
                const clickable = e.target.closest('.btn, .skill-card, .mode-card, .decision-option-card');
                if (clickable && typeof gameAnimations !== 'undefined') {
                    gameAnimations.createRipple(e, clickable);
                }
            });
        });

        function startGame(mode) {
            if (mode === 'real') {
                showRealBusinessSetup();
            } else {
                startAIChallenge();
            }
        }

        function showRealBusinessSetup() {
            const screen = document.getElementById('game-screen');
            screen.innerHTML = `
                <h2 style="margin-bottom: 30px;">ğŸ“ è®¾ç½®ä½ çš„ä¸šåŠ¡ Setup Your Business</h2>

                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">å…¬å¸åç§° Company Name</label>
                            <input type="text" id="company-name" placeholder="e.g., MyStartup"
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">è¡Œä¸š Industry</label>
                            <select id="industry" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                                <option value="saas">SaaSè½¯ä»¶æœåŠ¡</option>
                                <option value="ecommerce">ç”µå•† E-commerce</option>
                                <option value="social">ç¤¾äº¤åª’ä½“ Social Media</option>
                                <option value="fintech">é‡‘èç§‘æŠ€ FinTech</option>
                                <option value="education">æ•™è‚² Education</option>
                                <option value="marketplace">å¸‚åœºå¹³å° Marketplace</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">å½“å‰ç”¨æˆ·æ•° Current Users</label>
                            <input type="number" id="users" placeholder="e.g., 5000"
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">æœˆæ”¶å…¥ MRR ($)</label>
                            <input type="number" id="revenue" placeholder="e.g., 10000"
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">é¢„ç®— Budget ($)</label>
                            <input type="number" id="budget" placeholder="e.g., 5000"
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ ¸å¿ƒæŒ‘æˆ˜ Core Challenge</label>
                        <textarea id="challenge" placeholder="æè¿°ä½ å½“å‰é¢ä¸´çš„æœ€å¤§å¢é•¿æŒ‘æˆ˜..."
                                  style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; min-height: 100px;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ¯ éš¾åº¦é€‰æ‹© Difficulty Level</label>
                        <select id="difficulty" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;">
                            <option value="easy">ç®€å• Easy - æ›´å¤šèµ„æºï¼Œç®€å•å†³ç­–</option>
                            <option value="medium" selected>ä¸­ç­‰ Medium - å¹³è¡¡çš„æŒ‘æˆ˜</option>
                            <option value="hard">å›°éš¾ Hard - æœ‰é™èµ„æºï¼Œé«˜éš¾åº¦å†³ç­–</option>
                        </select>
                        <p style="color: #6c757d; font-size: 0.85em; margin-top: 5px;">
                            ğŸ’¡ éš¾åº¦å½±å“ï¼šåˆå§‹èµ„æºã€å†³ç­–å¤æ‚åº¦ã€éšæœºäº‹ä»¶é¢‘ç‡
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="initializeRealBusiness()">
                            ğŸš€ å¼€å§‹æ¸¸æˆ Start Game
                        </button>
                    </div>
                </div>
            `;

            switchScreen('game-screen');
        }

        function initializeRealBusiness() {
            const company = document.getElementById('company-name').value;
            const industry = document.getElementById('industry').value;
            const users = parseInt(document.getElementById('users').value) || 0;
            const revenue = parseInt(document.getElementById('revenue').value) || 0;
            const budget = parseInt(document.getElementById('budget').value) || 5000;
            const challenge = document.getElementById('challenge').value;
            const difficulty = document.getElementById('difficulty') ? document.getElementById('difficulty').value : 'medium';

            if (!company || !challenge) {
                alert('è¯·å¡«å†™å…¬å¸åç§°å’Œæ ¸å¿ƒæŒ‘æˆ˜ Please fill in company name and core challenge');
                return;
            }

            // Use advanced engine if available
            if (advancedSystemsEnabled && typeof GrowthGameEngineV2 !== 'undefined') {
                gameEngine = new GrowthGameEngineV2({
                    mode: 'real',
                    company: company,
                    industry: industry,
                    initialUsers: users,
                    initialRevenue: revenue,
                    budget: budget,
                    challenge: challenge,
                    difficulty: difficulty
                });

                // Initialize advanced systems
                const systems = gameEngine.initializeAdvancedSystems();
                comboSystem = systems.comboSystem;
                console.log('Advanced systems initialized:', systems);
            } else {
                // Fallback to basic engine
                gameEngine = new GrowthGameEngine({
                    mode: 'real',
                    company: company,
                    industry: industry,
                    initialUsers: users,
                    initialRevenue: revenue,
                    budget: budget,
                    challenge: challenge
                });
            }

            startLevel1();
        }

        function startAIChallenge() {
            // Show difficulty selection
            const screen = document.getElementById('game-screen');
            screen.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                    <h2 style="margin-bottom: 30px;">ğŸ® é€‰æ‹©éš¾åº¦ Select Difficulty</h2>

                    <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                        <div style="display: grid; gap: 15px;">
                            <div class="mode-card" onclick="initializeAIChallenge('easy')" style="cursor: pointer;">
                                <div class="icon">ğŸ˜Š</div>
                                <h3>ç®€å• Easy</h3>
                                <p>å……è¶³çš„èµ„æºï¼Œç®€å•çš„å†³ç­–ï¼Œé€‚åˆæ–°æ‰‹å­¦ä¹ </p>
                            </div>
                            <div class="mode-card" onclick="initializeAIChallenge('medium')" style="cursor: pointer;">
                                <div class="icon">ğŸ¯</div>
                                <h3>ä¸­ç­‰ Medium</h3>
                                <p>å¹³è¡¡çš„æŒ‘æˆ˜ï¼Œéœ€è¦ç­–ç•¥æ€è€ƒå’Œèµ„æºç®¡ç†</p>
                            </div>
                            <div class="mode-card" onclick="initializeAIChallenge('hard')" style="cursor: pointer;">
                                <div class="icon">ğŸ’ª</div>
                                <h3>å›°éš¾ Hard</h3>
                                <p>æœ‰é™çš„èµ„æºï¼Œé«˜éš¾åº¦å†³ç­–ï¼Œéšæœºäº‹ä»¶é¢‘ç¹</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            switchScreen('game-screen');
        }

        function initializeAIChallenge(difficulty) {
            // Use advanced engine if available
            if (advancedSystemsEnabled && typeof GrowthGameEngineV2 !== 'undefined') {
                gameEngine = new GrowthGameEngineV2({
                    mode: 'ai',
                    difficulty: difficulty
                });

                // Initialize advanced systems
                const systems = gameEngine.initializeAdvancedSystems();
                comboSystem = systems.comboSystem;
                console.log('Advanced systems initialized:', systems);
            } else {
                // Fallback to basic engine
                gameEngine = new GrowthGameEngine({
                    mode: 'ai'
                });
            }

            startLevel1();
        }

        function startLevel1() {
            updateMetrics();
            initializeOfficeScene();
            const level = gameEngine.getCurrentLevel();
            displayLevel(level);
        }

        function initializeOfficeScene() {
            const container = document.getElementById('office-scene-container');
            const scene = gameAnimations.initOfficeScene();
            container.innerHTML = '';
            container.appendChild(scene);
            container.style.display = 'block';

            // åˆå§‹æ›´æ–°
            gameAnimations.updateOfficeLevel(gameEngine.metrics.users);
        }

        function displayLevel(level) {
            document.getElementById('level-indicator').textContent = `å…³å¡ ${level.levelNumber}/6`;

            const screen = document.getElementById('game-screen');
            screen.innerHTML = `
                <div class="scenario-display">
                    <h2>ğŸ¯ ${level.title}</h2>
                    <p style="font-size: 1.1em; margin: 15px 0; line-height: 1.6;">${level.description}</p>

                    <div class="challenge-box">
                        <h3>ğŸ“Š å½“å‰çŠ¶å†µ Current Situation</h3>
                        <p>${level.situation}</p>
                    </div>
                </div>

                <div class="skills-available">
                    <h3 style="margin-bottom: 15px;">ğŸ’¡ é€‰æ‹©ä½ çš„å¢é•¿ç­–ç•¥ Choose Your Growth Strategy</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">é€‰æ‹©ä¸€ä¸ªç­–ç•¥æ¥åº”å¯¹è¿™ä¸ªæŒ‘æˆ˜ã€‚ä¸åŒçš„ç­–ç•¥æœ‰ä¸åŒçš„æˆæœ¬ã€æ—¶é—´å’Œæ•ˆæœã€‚</p>

                    <div class="skills-grid" id="skills-grid">
                        ${level.skills.map((skill, index) => `
                            <div class="skill-card" onclick="selectSkill(${index})" id="skill-${index}">
                                <div class="skill-cost">ğŸ’° $${skill.cost}</div>
                                <div class="skill-icon">${skill.icon}</div>
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-desc">${skill.description}</div>
                                ${skill.aarrr ? `<div class="skill-badge">${skill.aarrr}</div>` : ''}
                                <div style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                                    â±ï¸ ${skill.timeframe}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" id="execute-btn" onclick="executeStrategy()" disabled>
                        âš¡ æ‰§è¡Œç­–ç•¥ Execute Strategy
                    </button>
                </div>
            `;

            switchScreen('game-screen');
        }

        let selectedSkillIndex = null;

        function selectSkill(index) {
            const card = document.getElementById(`skill-${index}`);

            // Deselect all
            document.querySelectorAll('.skill-card').forEach(c => {
                gameAnimations.unhighlightCard(c);
                c.classList.remove('selected');
            });

            // Select this one with animation
            gameAnimations.highlightCard(card);
            gameAnimations.flipCard(card);
            selectedSkillIndex = index;

            // Enable execute button
            document.getElementById('execute-btn').disabled = false;
        }

        function executeStrategy() {
            if (selectedSkillIndex === null) return;

            // Use decision-based system if available
            if (advancedSystemsEnabled && decisionUI && typeof gameEngine.getSkillDecisions === 'function') {
                const skill = gameEngine.levels[gameEngine.currentLevel].skills[selectedSkillIndex];
                const decisions = gameEngine.getSkillDecisions(selectedSkillIndex);

                // Show decision sequence
                decisionUI.showDecisionSequence(skill, decisions, (choices) => {
                    // Execute skill with player choices
                    const result = gameEngine.executeSkillWithAdvancedSystems(selectedSkillIndex, choices);
                    displayResult(result);
                });
            } else {
                // Fallback to simple execution
                const result = gameEngine.executeSkill(selectedSkillIndex);
                displayResult(result);
            }
        }

        function displayResult(result) {
            const screen = document.getElementById('result-screen');
            screen.innerHTML = `
                <div class="result-panel">
                    <h3>${result.success ? 'ğŸ‰ ç­–ç•¥æ‰§è¡ŒæˆåŠŸï¼' : 'âš ï¸ æ•ˆæœä¸€èˆ¬'} Strategy Executed</h3>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4 style="margin-bottom: 15px;">ğŸ“ˆ ç»“æœåˆ†æ Results</h4>
                        <p style="line-height: 1.8;">${result.feedback}</p>
                    </div>

                    <div class="result-metrics">
                        ${result.changes.map(change => `
                            <div class="metric-card">
                                <div class="metric-label">${change.label}</div>
                                <div class="metric-value">${change.newValue}</div>
                                <div class="metric-change ${change.delta > 0 ? 'positive' : 'negative'}">
                                    ${change.delta > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change.delta)}${change.unit}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${result.activeSynergies && result.activeSynergies.length > 0 ? `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 10px;">âš¡ ååŒæ•ˆæœè§¦å‘ï¼ Synergy Activated!</h4>
                            ${result.activeSynergies.map(syn => `
                                <div style="margin-bottom: 10px;">
                                    <strong>${syn.icon} ${syn.name}</strong> - ${syn.multiplier}xæ•ˆæœ
                                    <p style="color: #856404; font-size: 0.9em;">${syn.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${result.comboBonus ? `
                        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">${result.comboBonus.icon} ${result.comboBonus.message}</h4>
                            <p style="color: #721c24;">${result.comboBonus.description || 'ç»§ç»­ä¿æŒä¼˜ç§€å†³ç­–!'}</p>
                        </div>
                    ` : ''}

                    ${result.achievement ? `
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 10px;">ğŸ† æˆå°±è§£é”ï¼ Achievement Unlocked!</h4>
                            <p style="color: #155724;"><strong>${result.achievement.title}</strong></p>
                            <p style="color: #155724;">${result.achievement.description}</p>
                        </div>
                    ` : ''}

                    <div style="text-align: center; margin-top: 30px;">
                        ${gameEngine.isGameComplete()
                            ? '<button class="btn btn-success" onclick="showFinalPlan()">ğŸŠ æŸ¥çœ‹å®Œæ•´è®¡åˆ’ View Final Plan</button>'
                            : '<button class="btn" onclick="nextLevel()">â¡ï¸ ä¸‹ä¸€å…³ Next Level</button>'
                        }
                    </div>
                </div>
            `;

            switchScreen('result-screen');

            // å…ˆæ›´æ–°æŒ‡æ ‡ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            updateMetrics();

            // æ›´æ–°åŠå…¬å®¤åœºæ™¯
            if (gameEngine.metrics.users) {
                gameAnimations.updateOfficeLevel(gameEngine.metrics.users);
            }

            // å»¶è¿Ÿæ˜¾ç¤ºæˆå°±ä»¥è·å¾—æ›´å¥½çš„ä½“éªŒ
            if (result.achievement) {
                setTimeout(() => showAchievement(result.achievement), 800);
            }
        }

        function nextLevel() {
            selectedSkillIndex = null;
            const level = gameEngine.getCurrentLevel();
            displayLevel(level);
        }

        function showFinalPlan() {
            // Record game completion for meta-progression
            if (metaProgression && gameEngine) {
                const summary = {
                    won: true,
                    finalUsers: gameEngine.metrics.users || 0,
                    finalRevenue: gameEngine.metrics.revenue || 0,
                    totalDecisions: gameEngine.history.length,
                    excellentDecisions: gameEngine.decisionHistory ?
                        gameEngine.decisionHistory.filter(d => d.quality === 'excellent').length : 0,
                    maxCombo: comboSystem ? comboSystem.comboState.maxCombo : 0
                };

                const result = metaProgression.recordGameCompletion(summary);
                console.log('Meta-progression updated:', result);
            }

            const plan = gameEngine.generateFinalPlan();
            const screen = document.getElementById('final-screen');

            screen.innerHTML = `
                <div class="final-plan">
                    <h2 style="text-align: center; font-size: 2.5em; margin-bottom: 30px;">
                        ğŸŠ æ­å–œå®Œæˆæ¸¸æˆï¼<br>
                        <span style="font-size: 0.6em; color: #6c757d;">Congratulations!</span>
                    </h2>

                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š æœ€ç»ˆæˆç»© Final Results</h3>
                        <div class="result-metrics">
                            ${plan.finalMetrics.map(metric => `
                                <div class="metric-card">
                                    <div class="metric-label">${metric.label}</div>
                                    <div class="metric-value">${metric.value}</div>
                                    <div class="metric-change positive">
                                        å¢é•¿ ${metric.growth}%
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${metaProgression ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; color: white;">
                            <h3 style="margin-bottom: 20px;">ğŸ® æ¸¸æˆè¿›åº¦ Meta-Progression</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.9em; opacity: 0.9;">ç­‰çº§ Level</div>
                                    <div style="font-size: 2.5em; font-weight: bold;">${metaProgression.playerProfile.level}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.9em; opacity: 0.9;">æ€»XP Total XP</div>
                                    <div style="font-size: 2.5em; font-weight: bold;">${metaProgression.playerProfile.totalXP}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.9em; opacity: 0.9;">æ¸¸æˆæ¬¡æ•° Games</div>
                                    <div style="font-size: 2.5em; font-weight: bold;">${metaProgression.playerProfile.gamesPlayed}</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 0.9em; margin-bottom: 5px;">è·ç¦»ä¸‹ä¸€çº§ To Next Level:</div>
                                <div style="background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden;">
                                    <div style="background: white; height: 20px; width: ${(metaProgression.playerProfile.totalXP / metaProgression.playerProfile.xpToNextLevel) * 100}%; transition: width 0.5s;"></div>
                                </div>
                                <div style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">
                                    ${metaProgression.playerProfile.totalXP} / ${metaProgression.playerProfile.xpToNextLevel} XP
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="plan-section">
                        <h3>ğŸ“‹ ä½ çš„å®Œæ•´å¢é•¿è®¡åˆ’ Your Complete Growth Plan</h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">
                            åŸºäºä½ åœ¨æ¸¸æˆä¸­çš„é€‰æ‹©ï¼Œæˆ‘ä»¬ä¸º <strong>${plan.company}</strong> ç”Ÿæˆäº†è¿™ä»½å®Œæ•´çš„å¢é•¿æ¨å¹¿è®¡åˆ’ã€‚
                        </p>

                        ${plan.phases.map((phase, index) => `
                            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0;">
                                <h4 style="color: #667eea; margin-bottom: 15px;">
                                    é˜¶æ®µ ${index + 1}: ${phase.title}
                                </h4>
                                <div class="timeline">
                                    ${phase.actions.map(action => `
                                        <div class="timeline-item">
                                            <div class="week-label">${action.week}</div>
                                            <div>
                                                <strong>${action.action}</strong><br>
                                                <span style="color: #6c757d; font-size: 0.9em;">${action.description}</span><br>
                                                <span style="color: #667eea; font-size: 0.85em;">é¢„æœŸ: ${action.expected}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="plan-section">
                        <h3>ğŸ¯ å…³é”®æˆåŠŸå› ç´  Key Success Factors</h3>
                        <ul style="line-height: 2; margin-left: 20px;">
                            ${plan.keyFactors.map(factor => `<li>${factor}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="plan-section">
                        <h3>ğŸ’¡ ä½ æŒæ¡çš„å¢é•¿é»‘å®¢æŠ€èƒ½ Growth Hacking Skills You've Mastered</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                            ${plan.skillsUsed.map(skill => `
                                <span style="background: #667eea; color: white; padding: 8px 15px; border-radius: 20px;">
                                    ${skill}
                                </span>
                            `).join('')}
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-success" onclick="downloadPlan()">
                            ğŸ“¥ ä¸‹è½½å®Œæ•´è®¡åˆ’ Download Plan
                        </button>
                        <button class="btn btn-secondary" onclick="location.reload()" style="margin-left: 15px;">
                            ğŸ”„ å†ç©ä¸€æ¬¡ Play Again
                        </button>
                    </div>
                </div>
            `;

            switchScreen('final-screen');
        }

        function downloadPlan() {
            const plan = gameEngine.generateFinalPlan();
            const content = gameEngine.generatePlanText();

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${plan.company}_Growth_Plan.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateMetrics() {
            const metrics = gameEngine.getMetrics();
            const dashboard = document.getElementById('metrics-dashboard');

            dashboard.innerHTML = metrics.map((metric, index) => `
                <div class="metric-card" data-metric="${metric.key || 'metric-' + index}">
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value" data-value="${metric.rawValue || metric.value}">${metric.value}</div>
                    ${metric.change ? `
                        <div class="metric-change ${metric.change > 0 ? 'positive' : 'negative'}">
                            ${metric.change > 0 ? 'â†‘' : 'â†“'} ${Math.abs(metric.change)}${metric.unit || ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // åŠ¨ç”»æ›´æ–°æŒ‡æ ‡
            animateMetricChanges(metrics);

            // æ›´æ–°æŒ‡æ ‡è„‰å†²çŠ¶æ€
            if (gameEngine.metrics) {
                gameAnimations.updateMetricPulses(gameEngine.metrics);
            }
        }

        function animateMetricChanges(metrics) {
            metrics.forEach((metric, index) => {
                const key = metric.key || 'metric-' + index;
                const element = document.querySelector(`[data-metric="${key}"] .metric-value`);

                if (element && previousMetrics[key] !== undefined) {
                    const oldValue = previousMetrics[key];
                    const newValue = parseFloat(metric.rawValue || metric.value.toString().replace(/[^0-9.-]/g, ''));

                    if (oldValue !== newValue) {
                        // æ•°å­—è®¡æ•°åŠ¨ç”»
                        gameAnimations.countUp(element, oldValue, newValue, 1000, (val) => {
                            return metric.formatter ? metric.formatter(val) : Math.floor(val).toLocaleString();
                        });

                        // æ£€æŸ¥é‡Œç¨‹ç¢‘
                        if (metric.key === 'users' || metric.key === 'revenue') {
                            gameAnimations.checkMilestone(oldValue, newValue, metric.key);
                        }
                    }
                }

                // ä¿å­˜å½“å‰å€¼
                previousMetrics[key] = parseFloat(metric.rawValue || metric.value.toString().replace(/[^0-9.-]/g, ''));
            });
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showAchievement(achievement) {
            // ä½¿ç”¨æ–°çš„åŠ¨ç”»ç³»ç»Ÿ
            gameAnimations.showAchievement({
                ...achievement,
                rarity: achievement.rarity || 'rare'
            });
        }

        function closeAchievement() {
            gameAnimations.closeAchievement();
        }
    </script>
</body>
</html>